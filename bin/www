#!/usr/bin/env node

'use strict';

var path = require('path');

var loggers = require('../logger');
loggers.configure(require('../config/logger.json'));
var logger = loggers.get('Application');

// Resource
require('../resource').configure({
  defaultLocale: 'fr',
  folders: {
    email: { template: '{{filename}}_{{locale}}.jade',
      dir: path.join(__dirname, '../resources/emails')
    }
  }
});

// Email
require('../email').configure(require('../config/email.json'));

// Database
var database = require('../database');
var databaseConfig = require('../config/database.json');

var redis = require('../tools/auth.js');
var redisConfig = require('../config/application').session;

database.connect(databaseConfig, function(err) {
  if (err) { return logger.error(err);} 
  redis.connect(redisConfig, function(err) {
    if (err) { return logger.error(err); }
    var app = require('../app');
    var appConfig = require('../config/application.json');
    app.set('port', process.env.PORT || appConfig.port || 9000);
    var server = app.listen(app.get('port'), function() {
        logger.info('Express server listening on port ' + server.address().port);
        require('../socket.io').connect(server);
    });
 });
});
